<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: Arial, sans-serif; padding: 12px; }
      .muted { color: #555; font-size: 12px; margin-top:6px; }
      input[type="password"], input[type="text"], input[type="number"] { padding: 8px; box-sizing: border-box; }
      input[type="password"] { width: 100%; }
      button { padding: 8px 12px; margin-top:8px; cursor:pointer; }
      #mainUI { display: none; }
      .row { margin:8px 0; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      .bar { width:100%; height:12px; background:#eee; border-radius:6px; overflow:hidden; }
      .fill { width:0%; height:100%; background:#4caf50; transition: width 120ms linear; }
      hr { margin:12px 0; border:0; border-top:1px solid #ddd; }
      .divider-strong { margin:14px 0; border:0; border-top:3px solid #000; }
      h2 { margin: 0 0 8px; }
      h3 { margin: 16px 0 8px; }
      .numInput { width: 90px; }
      .prefixInput { width: 90px; }
      .cellInput { width: 120px; }
      .valueInput { width: 150px; }
    </style>
  </head>
  <body>
    <!-- LOCKED VIEW -->
    <div id="locked">
      <h2>Enter Password</h2>
      <div class="muted">this console is password protected</div>
      <div class="row"><input id="pw" type="password" placeholder="Password" /></div>
      <div class="row"><button onclick="submitPassword()">Unlock</button></div>
      <div id="pwMsg" class="muted"></div>
    </div>

    <!-- MAIN UI -->
    <div id="mainUI">
      <!-- ==== DATA MANIPULATION CENTER ==== -->
      <h2>Data Manipulation Center</h2>

      <!-- RANGE SECTION -->
      <div class="row">
        <label>Start of Range:
          <input id="rangeStart" class="cellInput" type="text" placeholder="e.g. A1" />
        </label>
        <label>End of Range:
          <input id="rangeEnd" class="cellInput" type="text" placeholder="e.g. C10" />
        </label>
      </div>

      <div class="row">
        <div class="muted" id="rangeDisplay">Start: none | End: none</div>
      </div>

      <!-- SUBSECTION -->
      <hr>
      <h3>Set Cell Values</h3>

      <div class="row">
        <label>Cell set value:
          <input id="cellValue" class="valueInput" type="text" placeholder="Type a value..." />
        </label>
      </div>

      <div class="row">
        <button onclick="executeSet()">Execute</button>
        <button onclick="executeSetAll()">Execute All</button>
      </div>

      <div class="row">
        <div class="muted" id="valueDisplay">Cell value: none</div>
      </div>

      <div class="row">
        <div class="muted" id="executionStatus"></div>
      </div>

      <!-- BOLD SEPARATOR -->
      <hr class="divider-strong">

      <!-- ==== TAB CREATION CENTER ==== -->
      <h2>Tab Creation Center</h2>
      <h3>Create Tabs</h3>
      <div class="row">
        <label>Tabs to create:
          <input id="tabCount" class="numInput" type="number" value="10" min="1" max="30" />
        </label>
        <label>Prefix:
          <input id="createPrefix" class="prefixInput" type="text" value="t" />
        </label>
      </div>
      <div class="row">
        <button id="createBtn" onclick="startCreate()">üß© Create Random Tabs (with Progress)</button>
        <button onclick="quickDelete()">üóëÔ∏è Quick Delete Test Tabs</button>
      </div>
      <div class="row">
        <div class="bar"><div id="fillCreate" class="fill"></div></div>
        <div id="statusCreate" class="muted">Create progress: 0% (0/0)</div>
      </div>

      <hr>

      <h3>Delete Tabs</h3>
      <div class="row">
        <label>Prefix to delete:
          <input id="prefix" class="prefixInput" type="text" value="t" />
        </label>
        <button id="startBtn" onclick="startDelete()">‚öôÔ∏è Delete Tabs (with Progress)</button>
      </div>
      <div class="row">
        <div class="bar"><div id="fillDelete" class="fill"></div></div>
        <div id="statusDelete" class="muted">Delete progress: 0% (0/0)</div>
      </div>
    </div>

    <script>
      /* ---------- PASSWORD ---------- */
      function submitPassword() {
        const p = document.getElementById('pw').value || '';
        document.getElementById('pwMsg').textContent = 'Checking‚Ä¶';
        google.script.run
          .withSuccessHandler(ok => {
            if (ok === true) {
              document.getElementById('locked').style.display = 'none';
              document.getElementById('mainUI').style.display = 'block';
            } else {
              document.getElementById('pwMsg').textContent = 'Incorrect password.';
            }
          })
          .withFailureHandler(err => {
            document.getElementById('pwMsg').textContent = 'Error checking password.';
            console.error(err);
          })
          .checkPassword(p);
      }

      /* ---------- RANGE + VALUE INPUT ---------- */
      const startInput = document.getElementById('rangeStart');
      const endInput = document.getElementById('rangeEnd');
      const valueInput = document.getElementById('cellValue');
      const rangeDisplay = document.getElementById('rangeDisplay');
      const valueDisplay = document.getElementById('valueDisplay');
      const executionStatus = document.getElementById('executionStatus');

      function updateRangeDisplay() {
        const s = startInput.value.trim() || "none";
        const e = endInput.value.trim() || "none";
        rangeDisplay.textContent = `Start: ${s} | End: ${e}`;
      }

      function updateValueDisplay() {
        const v = valueInput.value.trim() || "none";
        valueDisplay.textContent = `Cell value: ${v}`;
      }

      startInput.addEventListener('input', updateRangeDisplay);
      endInput.addEventListener('input', updateRangeDisplay);
      valueInput.addEventListener('input', updateValueDisplay);

      function readInputs() {
        const start = startInput.value.trim();
        const end = endInput.value.trim();
        const val = valueInput.value.trim();
        if (!start || !end || !val) {
          executionStatus.textContent = "‚ö†Ô∏è Please fill in start, end, and value fields first.";
          return null;
        }
        return { start, end, val };
      }

      function executeSet() {
        const args = readInputs();
        if (!args) return;
        executionStatus.textContent = "Running...";
        google.script.run
          .withSuccessHandler(count => {
            executionStatus.textContent = `‚úÖ Set ${count} cells from ${args.start} to ${args.end} to "${args.val}" on the active sheet.`;
          })
          .withFailureHandler(err => {
            executionStatus.textContent = `‚ùå Error: ${err.message || err}`;
          })
          .setRangeValue(args.start, args.end, args.val);
      }

      function executeSetAll() {
        const args = readInputs();
        if (!args) return;
        executionStatus.textContent = "Running on all sheets...";
        google.script.run
          .withSuccessHandler(res => {
            executionStatus.textContent = `‚úÖ Set ${res.cells} cells across ${res.sheets} sheets from ${args.start} to ${args.end} to "${args.val}".`;
          })
          .withFailureHandler(err => {
            executionStatus.textContent = `‚ùå Error: ${err.message || err}`;
          })
          .setRangeValueAllSheets(args.start, args.end, args.val);
      }

      /* ---------- TAB CREATION + DELETE CENTER ---------- */
      let creating = false, createTotal = 0, createDone = 0;
      function setCreateProgress() {
        const pct = createTotal === 0 ? 0 : Math.round((createDone / createTotal) * 100);
        document.getElementById('fillCreate').style.width = pct + '%';
        document.getElementById('statusCreate').textContent =
          `Create progress: ${pct}% (${createDone}/${createTotal})`;
      }

      function startCreate() {
        if (creating) return;
        const numTabs = Math.max(1, Math.min(30, parseInt(document.getElementById('tabCount').value || '1', 10)));
        const prefix = (document.getElementById('createPrefix').value || 't').trim() || 't';
        google.script.run.withSuccessHandler(maxSafe => {
          const capped = Math.min(numTabs, maxSafe || 30);
          creating = true; createTotal = capped; createDone = 0;
          document.getElementById('createBtn').disabled = true;
          setCreateProgress();
          createNext(prefix);
        }).getCreateMaxSafe();
      }

      function createNext(prefix) {
        if (createDone >= createTotal) {
          creating = false;
          document.getElementById('createBtn').disabled = false;
          setCreateProgress();
          return;
        }
        google.script.run
          .withSuccessHandler(() => { createDone++; setCreateProgress(); createNext(prefix); })
          .withFailureHandler(err => { console.log('Create error:', err); createDone++; setCreateProgress(); createNext(prefix); })
          .createOneRandomTab(prefix);
      }

      function quickDelete() {
        const prefix = (document.getElementById('createPrefix').value || 't').trim() || 't';
        document.getElementById('statusDelete').textContent = `Quick delete started for prefix "${prefix}"‚Ä¶`;
        google.script.run
          .withSuccessHandler(() => { document.getElementById('statusDelete').textContent = `Quick delete finished for "${prefix}".`; })
          .withFailureHandler(err => { document.getElementById('statusDelete').textContent = `Error: ${err.message || err}`; })
          .deleteTestTabs(prefix);
      }

      let deleting = false, queue = [], delTotal = 0, delDone = 0;
      function setDeleteProgress() {
        const pct = delTotal === 0 ? 0 : Math.round((delDone / delTotal) * 100);
        document.getElementById('fillDelete').style.width = pct + '%';
        document.getElementById('statusDelete').textContent =
          `Delete progress: ${pct}% (${delDone}/${delTotal})`;
      }

      function startDelete() {
        if (deleting) return;
        delDone = 0; setDeleteProgress();
        document.getElementById('startBtn').disabled = true;
        const prefix = (document.getElementById('prefix').value || '').trim();
        google.script.run
          .withSuccessHandler(names => {
            queue = names || [];
            delTotal = queue.length;
            setDeleteProgress();
            if (delTotal === 0) {
              document.getElementById('statusDelete').textContent = 'No matching tabs found.';
              document.getElementById('startBtn').disabled = false;
              return;
            }
            deleting = true;
            deleteNext();
          })
          .withFailureHandler(err => {
            document.getElementById('statusDelete').textContent = `Error: ${err.message || err}`;
            document.getElementById('startBtn').disabled = false;
          })
          .listSheetsToDelete(prefix);
      }

      function deleteNext() {
        if (queue.length === 0) {
          setDeleteProgress();
          deleting = false;
          document.getElementById('startBtn').disabled = false;
          return;
        }
        const name = queue.shift();
        google.script.run
          .withSuccessHandler(result => { if (result && result.deleted) delDone++; setDeleteProgress(); deleteNext(); })
          .withFailureHandler(err => { console.log('Delete error for', name, err); setDeleteProgress(); deleteNext(); })
          .deleteSheetByName(name);
      }
    </script>
  </body>
</html>
