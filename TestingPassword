<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <base target="_top">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    html,body{
      height:100%;margin:0;overflow:hidden;background:#f3f4f6;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#0f172a;
    }
    .user-chip{position:fixed;top:14px;left:14px;display:none;align-items:center;gap:10px;
      padding:8px 10px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;
      box-shadow:0 8px 20px rgba(2,6,23,.08);width:220px;z-index:9999;}
    .user-chip img{width:36px;height:36px;border-radius:10px;object-fit:cover;background:#f1f5f9;border:1px solid #e5e7eb;}
    .user-text{line-height:1.05;overflow:hidden;}
    .name-line{font-weight:800;font-size:.95rem;color:#111827;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;}
    .email-line{font-size:.8rem;color:#64748b;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;}
    .time-box{position:fixed;top:78px;left:14px;width:220px;padding:6px 0;border:1px solid #e5e7eb;border-radius:12px;
      background:#fff;box-shadow:0 8px 20px rgba(2,6,23,.08);text-align:center;font-weight:700;font-size:1rem;color:#111827;display:none;z-index:9998;}
    .wrap{height:100%;width:100%;display:grid;place-items:center;padding:24px;box-sizing:border-box;}
    .alert{width:min(920px,92%);min-height:540px;background:#fff;border:1px solid #e5e7eb;border-radius:14px;
      box-shadow:0 20px 60px rgba(2,6,23,.12);padding:0;overflow:hidden;transition:opacity .25s ease,transform .25s ease;}
    .header{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid #e5e7eb;}
    .brand{display:flex;align-items:center;gap:10px;}
    .icon{width:38px;height:38px;border-radius:10px;display:grid;place-items:center;background:#f8fafc;border:1px solid #e5e7eb;}
    .title{margin:0;font-size:1.1rem;font-weight:800;}
    .content{padding:22px;}
    .pw-card{padding:8px 0;text-align:center;}
    .desc{margin:0 0 12px;color:#475569;font-size:.98rem;}
    .pw-form{display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:8px;}
    .input{width:280px;height:40px;border:1px solid #e5e7eb;border-radius:10px;background:#f9fafb;
      padding:0 12px;font-size:1rem;outline:none;text-align:center;transition:border-color .12s ease,background .12s ease;}
    .input:focus{border-color:#cbd5e1;background:#fff;}
    .btn{width:140px;height:40px;border:1px solid #e5e7eb;border-radius:10px;background:#111827;color:#fff;
      font-weight:800;letter-spacing:.3px;cursor:pointer;user-select:none;}
    .btn:disabled{opacity:.55;cursor:not-allowed;}
    .status{margin-top:10px;color:#6b7280;min-height:1.25em;font-size:.98rem;}
    .status.ok{color:#166534;} .status.bad{color:#b91c1c;} .status.chk{color:#374151;}
    .repo-info{margin-top:10px;font-size:.85rem;color:#94a3b8;user-select:none;}
    .hello{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) translateY(10px);
      font-size:3rem;font-weight:800;letter-spacing:.5px;opacity:0;transition:opacity 600ms ease,transform 600ms ease;pointer-events:none;}
    .hello.enter{opacity:1;transform:translate(-50%,-50%) translateY(0);}
    .hello.leave{opacity:0;transform:translate(-50%,-50%) translateY(-80px);}
  </style>
</head>
<body>
  <div id="userChip" class="user-chip"><img id="userImg"><div class="user-text"><div id="userName" class="name-line"></div><div id="userEmail" class="email-line"></div></div></div>
  <div id="timeBox" class="time-box">--:--:--</div>

  <div class="wrap">
    <div id="alertBox" class="alert">
      <div class="header">
        <div class="brand">
          <div class="icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#334155" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3.5" y="10" width="17" height="10.5" rx="2.5"/><path d="M7.5 10V7a4.5 4.5 0 1 1 9 0v3"/></svg></div>
          <h1 class="title">Vexium</h1>
        </div>
      </div>
      <div class="content">
        <div class="pw-card" id="pwCard">
          <p class="desc">This console is password protected.</p>
          <div class="pw-form">
            <input id="pw" class="input" type="password" placeholder="passphrase" autocomplete="current-password">
            <button id="go" class="btn" type="button">Enter</button>
            <div id="status" class="status">Waiting…</div>
          </div>
          <div id="repoInfo" class="repo-info">Last time updated: —</div>
        </div>
      </div>
    </div>
  </div>

  <div id="hello" class="hello" aria-hidden="true">hello</div>

  <script>
    /* ----------------- small helpers ----------------- */
    const $ = id => document.getElementById(id);
    function escapeHtml(s){
      if(s==null) return "";
      return String(s).replace(/[&<>"']/g, function(m){
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
      });
    }

    const alertBox=$("alertBox"),pw=$("pw"),go=$("go"),statusEl=$("status"),helloEl=$("hello");

    function setStatus(k,t){statusEl.className="status "+(k||"");statusEl.textContent=t;}
    function setBusy(b){go.disabled=b;pw.disabled=b;if(b&&document.activeElement)document.activeElement.blur();}
    function playHello(){helloEl.style.opacity="0";helloEl.classList.remove("enter","leave");void helloEl.offsetWidth;
      requestAnimationFrame(()=>{helloEl.classList.add("enter");setTimeout(()=>{void helloEl.offsetWidth;helloEl.classList.add("leave");},800);});}

    /* -------- user card -------- */
    function loadNameCard(){
      const chip=$("userChip"),img=$("userImg"),nameEl=$("userName"),emailEl=$("userEmail");
      google.script.run.withSuccessHandler(d=>{
        const n=(d&&d.name)||"User",e=(d&&d.email)||"",p=(d&&d.photoDataUrl)||"";
        nameEl.textContent=n;emailEl.textContent=e;if(p){img.src=p;img.alt=n;}chip.style.display="inline-flex";
      }).withFailureHandler(()=>{$("userName").textContent="User";chip.style.display="inline-flex";}).getUserCardData();
    }

    /* -------- clock -------- */
    function startClockOnce(){if(window._clockStarted)return;window._clockStarted=true;
      const b=$("timeBox");b.style.display="inline-block";
      function tick(){const n=new Date();b.textContent=`${String(n.getHours()).padStart(2,"0")}:${String(n.getMinutes()).padStart(2,"0")}:${String(n.getSeconds()).padStart(2,"0")}`;}
      tick();setInterval(tick,1000);}

    /* -------- login flow -------- */
    function submit(){
      const v=(pw.value||"").trim();if(!v){setStatus("bad","Please enter a passphrase.");return;}
      setStatus("chk","checking…");setBusy(true);
      google.script.run.withSuccessHandler(r=>{
        if(r&&r.ok){
          alertBox.style.opacity="0";alertBox.style.transform="scale(.98)";setTimeout(()=>{alertBox.style.visibility="hidden";},250);
          playHello();loadNameCard();startClockOnce();
        }else{
          if(r&&r.reason==="lockdown"){renderLockdown(r.message,r.owner);return;}
          if(r&&r.pwOk&&!r.driveOk){setStatus("bad","you are not authenticated");}
          else{setStatus("bad","incorrect password");}
          setBusy(false);
        }
      }).withFailureHandler(()=>{setStatus("","checking failed — try again");setBusy(false);}).authenticate(v);
    }
    go.addEventListener("click",submit);
    pw.addEventListener("keydown",e=>{if(e.key==="Enter")submit();});

    /* -------- repo info -------- */
    (function initRepoInfo(){
      const line=$("repoInfo");
      google.script.run.withSuccessHandler(r=>{
        if(!r||!r.ok||!r.isoUtc){line.textContent="Last time updated: —";return;}
        line.textContent="Last time updated: "+timeAgoUTC(r.isoUtc);
      }).withFailureHandler(()=>{line.textContent="Last time updated: —";}).getTemplateLastUpdated();
    })();

    function timeAgoUTC(iso){
      try{const t=new Date(iso),n=new Date(),s=Math.max(0,Math.floor((n-t)/1000));
        const u=[["year",31536000],["month",2592000],["day",86400],["hour",3600],["minute",60],["second",1]];
        for(const [name,size] of u){const v=Math.floor(s/size);if(v>=1)return`${v} ${name}${v>1?"s":""} ago (UTC)`;}return"just now (UTC)";
      }catch(_){return"—";}
    }
    setTimeout(()=>pw&&pw.focus(),0);

    /* ===== Lockdown auto-poll (shows custom message + scrollable owner box + admin bypass) ===== */
    function renderLockdown(mainMsg, ownerMsg){
      const m = escapeHtml(mainMsg || "Vexium is in lockdown");
      const o = escapeHtml(ownerMsg || "");
      document.documentElement.innerHTML = `
        <!doctype html><meta charset="utf-8">
        <style>
          body{font-family:system-ui,Segoe UI,Arial;display:flex;min-height:100vh;align-items:center;justify-content:center;margin:0;background:#fafafa}
          .card{max-width:760px;background:#fff;border:1px solid #eee;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:28px 28px 20px;text-align:center}
          h1{margin:0 0 8px;font-size:28px}
          p{margin:6px 0 14px;color:#444}
          .owner{margin-top:14px;text-align:left;background:#f8fafc;border:1px solid #e5e7eb;border-radius:10px;padding:12px;max-height:260px;overflow:auto;white-space:pre-wrap}
          .bypass-wrap{margin-top:14px}
          .bypass-btn{padding:10px 14px;border-radius:10px;border:1px solid #e5e7eb;background:#111827;color:#fff;font-weight:800;cursor:pointer}
          .bypass-note{margin-top:8px;color:#64748b;font-size:.9rem}
        </style>
        <div class="card">
          <div id="bypassArea"></div>
          <h1 id="mainMsg">${m}</h1>
          <div class="owner"><strong>Owner message</strong><br>${o}</div>
        </div>

        <script>
          function tryRenderBypass(){
            var area = document.getElementById("bypassArea");
            area.innerHTML = '';
            try{
              google.script.run.withSuccessHandler(function(allowed){
                if(allowed){
                  area.innerHTML = '<div class="bypass-wrap"><button id="adminBypass" class="bypass-btn">Admin Bypass</button><div class="bypass-note">Use this if you are an authorized admin.</div></div>';
                  document.getElementById("adminBypass").addEventListener("click", function(){
                    this.disabled = true; this.textContent = "Bypassing…";
                    google.script.run.withSuccessHandler(function(res){
                      if(res && res.ok){
                        location.reload();
                      }else{
                        alert("Bypass failed: " + (res && res.reason ? res.reason : "unknown"));
                        var b=document.getElementById("adminBypass");
                        if(b){ b.disabled = false; b.textContent = "Admin Bypass"; }
                      }
                    }).withFailureHandler(function(){
                      alert("Bypass request failed.");
                      var b=document.getElementById("adminBypass");
                      if(b){ b.disabled = false; b.textContent = "Admin Bypass"; }
                    }).attemptBypass();
                  });
                }
              }).isOwnerBypassAvailable();
            }catch(e){}
          }
          tryRenderBypass();
        <\/script>
      `;
    }

    function checkLockdown(){
      google.script.run.withSuccessHandler(res=>{
        if(res&&res.on){renderLockdown(res.message,res.owner);}
      }).isExternalLockdownActive();
    }
    setInterval(checkLockdown,8000);
    checkLockdown();
  </script>
</body>
</html>
